// Copyright Â© 2021 Lautsprecher Teufel GmbH. All rights reserved.

import Foundation
import FoundationExtensions
import Helper

public struct CocoaPodsPlist: Codable {
    let preferenceSpecifiers: [Item]
    let stringsTable = "Acknowledgements"
    let title = "Acknowledgements"

    init(items: [Item]) {
        preferenceSpecifiers = [
            // Add header
            Item(title: "Acknowledgements", license: nil, footerText: "This application makes use of the following third party libraries:")
        ] + items + [
            // Add footer
            Item(title: "", license: nil, footerText: "Generated by SpmAck")
        ]
    }

    public struct Item: Codable {
        let type: String = "PSGroupSpecifier"
        let title: String
        let license: String?
        let footerText: String

        enum CodingKeys: String, CodingKey {
            case type = "Type"
            case title = "Title"
            case license = "License"
            case footerText = "FooterText"
        }
    }

    enum CodingKeys: String, CodingKey {
        case preferenceSpecifiers = "PreferenceSpecifiers"
        case stringsTable = "StringsTable"
        case title = "Title"
    }
}

public func saveToPList(
    cocoaPods: CocoaPodsPlist,
    path: String
) -> Reader<(FileSave, Encoder<CocoaPodsPlist>), Result<Void, GeneratePlistError>> {
    Reader { fileSave, encoder in
        encoder(cocoaPods)
            .flatMap { fileSave(path, $0) }
            .mapError(GeneratePlistError.cocoaPodsPListCannotBeEncoded)
    }
}
